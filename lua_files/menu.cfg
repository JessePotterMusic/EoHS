{EOHS_LUA_FILE (<<-- menu.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery

local g = function(contents) return { "grid", contents } end
local r = function(contents) return { "row", contents } end
local c = function(contents) return { "column", contents } end
local spacer = { "spacer", {}}

EoHS.menu_item_invoked = function()
  local units = EoHS.get_units({ EoHS.is_on_the_map })
  for i,unit in ipairs(units) do
    if EoHS.standardize_unit(unit) then EoHS.put_unit(unit) end
  end
  local choice = EoHS.synchronize_choice(function()
    local trainers = {}
    local actors = {}
    for i,unit in ipairs(units) do
      if unit.side == wesnoth.current.side then
        if EoHS.unit_can_train  (unit) then table.insert(trainers, unit) end
        if EoHS.unit_has_actions(unit) then table.insert(actors, unit) end
      end
    end
    
    local sx,sy = wesnoth.get_selected_tile()
    local dwu = wesnoth.get_displayed_unit()
    local trainers_sort = function(a,b)
      sa = EoHS.unit_skill_points_left(a)
      sb = EoHS.unit_skill_points_left(b)
      if (sa > 0) and (sb <= 0) then return true  end
      if (sb > 0) and (sa <= 0) then return false end
      if         a.x ==    sx and a.y ==    sy then return true  end
      if         b.x ==    sx and b.y ==    sy then return false end
      if dwu and a.x == dwu.x and a.y == dwu.y then return true  end
      if dwu and b.x == dwu.x and b.y == dwu.y then return false end
      if sa > sb then return true  end
      if sb > sa then return false end
      return a.underlying_id < b.underlying_id
    end
    local actors_sort = function(a,b)
      if         a.x ==    sx and a.y ==    sy then return true  end
      if         b.x ==    sx and b.y ==    sy then return false end
      if dwu and a.x == dwu.x and a.y == dwu.y then return true  end
      if dwu and b.x == dwu.x and b.y == dwu.y then return false end
      -- TODO: compare AP and distance
      return a.underlying_id < b.underlying_id
    end
    table.sort(trainers, trainers_sort)
    table.sort(actors, actors_sort)
    
    local finished = false
    local result
    local mode, subject
    local parameters = {
      target_x = wesnoth.get_variable("x1"),
      target_y = wesnoth.get_variable("y1"),
    }
    local selected_skillsets = {}
    for i,unit in ipairs(trainers) do
      local skillset = EoHS.get_unit_skillset(unit)
      if not skillset then EoHS.err("skillset not inited") end
      selected_skillsets[unit.underlying_id] = EoHS.deep_copy(skillset)
    end
    local set_subject = function(new_subject)
      subject = new_subject
      parameters.actor_id = subject.underlying_id
    end
    local set_mode = function(new_mode)
      mode = new_mode
    end
    if trainers[1] and (EoHS.unit_skill_points_left(trainers[1]) > 0) then
      set_mode("training")
    elseif actors[1] then
      set_mode("actions")
    else
      set_mode("instructions")
    end
    
    local loc_info_grid = function(x,y)
      local unit = EoHS.get_unit(x,y)
      if unit then
        return unit_info_grid(unit)
      end
      return g{r{c{ {"label",{label = "("..x..","..y..")"}} }}}
      -- TODO a picture
    end
    
    while not finished do
      if mode == "training" and not (subject and EoHS.unit_can_train(subject)) then set_subject(trainers[1]) end
      if mode == "actions" then
        if not (subject and EoHS.unit_has_actions(subject)) then set_subject(actors[1]) end
        if not (parameters.action_id and EoHS.unit_has_action(subject, parameters.action_id)) then parameters.action_id = EoHS.unit_actions(subject)[1] end
      end
      local d = EoHS.make_dialog_context(function()
        if (mode == "actions") and parameters.action_id then
          if EoHS.err("TODO") then
            finished = true
            result = { type="action", {"parameters",parameters} }
          end
        end
        if mode == "training" then
          if EoHS.unit_total_skill_points(subject) >= EoHS.skillset_points_spent(selected_skillsets[subject.underlying_id]) then
            finished = true
            result = { type="training", trainer_id = subject.underlying_id, {"skillset",selected_skillsets[subject.underlying_id] } }
          end
        end
      end, function()
        finished = true
        result = { type="cancel" }
      end)
      
      local modes_row = {}
      do
        local make_mode_button = function(button_mode, name, image)
          local canvas_extras = { {"text",{
            x = "(if(text_width < (width+2-height), ((width+2-height) - text_width) / 2 + (height-2), height-4))",
            y = EoHS.macros.GUI__TEXT_VERTICALLY_CENTRED,
            w = "(text_width)",
            h = "(text_height)",
            font_size = 14,
            color = "221, 221, 221, 255",
            text = name,
          }}, {"image",{
            x = 2,
            y = 2,
            w = "(height-4)",
            h = "(height-4)",
            name = image,
          }} }
          table.insert(modes_row, c{ EoHS.fake_listbox_entry(d, name.."mmmmmm\nm\nm", canvas_extras, mode == button_mode, function() set_mode(button_mode) end) })
        end
        if trainers[1] then make_mode_button("training"    , _"Training"    , "attacks/woodensword.png") end
        if   actors[1] then make_mode_button("actions"     , _"Actions"     , "attacks/staff-magic.png") end
                            make_mode_button("instructions", _"Instructions", "attacks/woodensword.png")
      end
      local modes_grid = g{r(modes_row)}
      
      local subjects_row = {}
      do
        local make_subject_button = function(button_subject)
          local extra_strings = {}
          if mode == "training" then
            table.insert(extra_strings, EoHS.substitute("$1| SP",{EoHS.unit_skill_points_left(button_subject)}))
          end
          if mode == "actions" then
            table.insert(extra_strings, EoHS.substitute("$1| AP",{EoHS.unit_action_points(button_subject)}))
            local mana = EoHS.get_unit_variable(button_subject, "mana")
            if mana then
              table.insert(extra_strings, EoHS.substitute("$1| mana",{mana}))
            end
          end
          table.insert(subjects_row, c{ EoHS.fake_listbox_entry(d, "mmmmmmmmmmmmmm\nm\nm\nm", EoHS.unit_info_canvas(button_subject, extra_strings), subject == button_subject, function() set_subject(button_subject) end) })
        end
        if mode == "training" then for i,unit in ipairs(trainers) do make_subject_button(unit) end end
        if mode == "actions"  then for i,unit in ipairs(  actors) do make_subject_button(unit) end end
      end
      local subjects_grid = g{r(subjects_row)}
      
      local move_target_button = function(direction)
        return d.button({label=direction}, function()
          parameters.target_x,parameters.target_y = EoHS.get_loc_in_direction(parameters.target_x,parameters.target_y, direction)
        end)
      end
      local target_grid = g{
        r{ c{spacer}, c{move_target_button("n")}, c{spacer} },
        r{ c{g{r{c{move_target_button("nw")}},r{c{move_target_button("sw")}}}}, c{loc_info_grid(parameters.target_x,parameters.target_y)}, c{g{r{c{move_target_button("ne")}},r{c{move_target_button("se")}}}} },
        r{ c{spacer}, c{move_target_button("s")}, c{spacer} },
      }
      local contents
      if mode == "training" then
        local training_grid = EoHS.training_dialog_grid(d, selected_skillsets[subject.underlying_id], EoHS.get_unit_skillset(subject), EoHS.unit_total_skill_points(subject))
        contents = g{
          r{c{subjects_grid}},
          r{c{training_grid}},
        }
      end
      if mode == "actions" then
        local switch_func = function(id)
          return function()
            parameters.action_id = id
          end
        end
        local actions_grid = g{
          r{ c{EoHS.action_list_dialog_grid(d,parameters,switch_func)}, c{EoHS.action_dialog_stuff(d,parameters)} },
        }
        contents = g{
          r{c{g{r{c{subjects_grid},c{target_grid}}}}},
          r{c{actions_grid}},
        }
      end
      if mode == "instructions" then
        contents = {"label",{label=_"Rules desc here"}}
      end
      --EoHS.err(EoHS.inspect(contents))
      d.show(g{r{c{modes_grid}},r{c{contents}}})
    end
    return result
  end, function() EoHS.err("An AI invoked the EoHS menu item?!?") end)
  
  if choice.type == "training" then
    local unit = EoHS.get_unit(choice.trainer_id)
    EoHS.set_unit_skillset(unit, choice[1][2])
    EoHS.put_unit(unit)
  end
  if choice.type == "action" then
    EoHS.do_action(choice[1][2])
  end
end

>>)}
