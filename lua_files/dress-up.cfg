{EOHS_LUA_FILE (<<-- dress-up.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery

--[[shared colors:
c5956a 73432b a9794f 5d422f 7b4231(human_skin and elf_hair)
73432b also elf skin?
f6d39b faf3c9 784838 human_skin and elf_skin
f6d39b also elf_hair?
elder_mage_hair is also lich bones

ffefc6 a trouble color: human_skin and male_wizard_hair. Make sure the beard is cropped away from the rest when recolored
ebd5bc a trouble color: female mage hair, but also book]]

local dress_up_palettes = {
  human_skin = "f8c090 c5956a 73432b f6d39b a9794f 561b00 d8a67a faf3c9 876246 d08f52 5d422f 784838 936920 f8e0c3 b17632 f8c393 cf7f62e b15902 6b3c0b f9c292 ffefc6 ce8463 704010 723e0d 7b4231 b18f75 ffffff",
  ruffian_skin = "human_skin 89624f dbad69 b57e62 e6c1b1",
  ruffian_hair = "4b2f27 512425 cb7258 d49567 914f42 dab26f c26f54 c99447 73473a d8ad6b d39564 62292a d29262 d3a55e be895b bc9562 6b3b2e 964f41 9b5b47 a25e49 995042 715732 75483a 723932 86483f 55382f 8c5644 6b4134 50372c 3f2f27",
  elf_hair = "c5956a 73432b a9794f 5d422f 7b4231 f3f4b5 dec497 f3f4b7 f4f5be f4f5ba f4f5bd ffffff c7986f c1a694 907859 6d532e 834d3e c6976d c1a694 e2cba3 f3f4b6 e0c79c e7e8e7 c79970 e0c89e e1caa1 cb9f77 f6f7c6 e5d0ad e6d3b3 c99c74 c99d75 f7f8ce f5f6c4 e2e3e2 c89a70 dedfde c99c73 f7d8a6 cda37d edd8b8",
  elf_skin = "f6d39b faf3c9 fdd595 d2a57d 784838 ffffff",
  male_wizard_hair = "8b3219 c18371 ffefc6 dab0a4 592010 a9543c 44260d 4c4439",
  female_wizard_hair = "fcfcfc ebd5bc cfa87a ffffff 9a7458 7a4a3f 4e3430 886962 d9bab7",
  elder_mage_skin = "human_skin 7b4231 f3c49e c2876d f9e2ce daab85 949473 dba086 c1926c a68574",
  elder_mage_hair = "d6d69c ffffce 949473 525239 b6b68a e6e6b5 6b6b52",
  redplus_coat = "808080 bfbfbf 999999 595959 424242 ffffff 5a5a5a 7a7a7a ababab 535353",
  redmage_robes = "de8b6d ab6b54 59382c 8c5845 683a28 422110 bdae8d ffffff",
  redmage_pants = "8a9f75 5d583c 575233 3f3321 ffffff",
  mage_robes = "b18134 8a5c2f 4f2d29 75462f 5a3819 804018 582820",
  mage_staff = "fcd580 f8dd79 e5b263 e1be72 f9cb75 ffe88f ffe38d f8d27e a46d31 daa85d dbab60 b69557 b69d5e 9f6a2f 957153 94744c 8f5c27 6d4217 481f07 3b240b",
  archplus_robes = "cabca2 a4977e 8c7f67 635841 ffffff 4b402b 847860 2d2410",
  boots_and_frills = "c67b02 ffe38c faca58 84401e 86461b 422110 985810 582820 c08008 84411f",
  mage_shoes = "d6d6d6 5a5a5a 7a7a7a ababab",
  staves_greatmageorb = "d6d6d6 a8a098 6a7477 ",
  lich_staff = "f8c838 c87020 704028",
  lich_robes = "889880 506858 283028 313131 4b6152 344036 44584a 303130",
  rogue_hair = "d7f0f0 b9cee4 85a7ca 617cab 496697 384f76 293d5f",
}
for k,v in pairs(dress_up_palettes) do
  v = string.gsub(v, "human_skin", dress_up_palettes["human_skin"])
  v = string.gsub(v, " ffffff", "") -- TODO: more nuance
  v = string.gsub(v, " ", ",")
  dress_up_palettes[k] = v
end

local eye_offsets = {
  ["units/undead-necromancers/lich.png"             ] = { x = 36, y = 19 },
  ["units/undead-necromancers/lich-magic-1.png"     ] = { x = 36, y = 19 },
  ["units/undead-necromancers/lich-magic-2.png"     ] = { x = 36, y = 18 },
  ["units/undead-necromancers/lich-magic-3.png"     ] = { x = 35, y = 18 },
  ["units/undead-necromancers/lich-defend.png"      ] = { x = 35, y = 19 },
  ["units/undead-necromancers/lich-idle-1.png"      ] = { x = 36, y = 19 },
  ["units/undead-necromancers/lich-idle-2.png"      ] = { x = 36, y = 19 },
  ["units/undead-necromancers/lich-idle-3.png"      ] = { x = 36, y = 19 },
  ["units/undead-necromancers/lich-melee-1.png"     ] = { x = 37, y = 19 },
  ["units/undead-necromancers/lich-melee-2.png"     ] = { x = 38, y = 20 },
  ["units/human-magi/mage.png"                      ] = { x = 34, y = 25 },
  ["units/human-magi/mage-attack-magic1.png"        ] = { x = 34, y = 25 },
  ["units/human-magi/mage-attack-magic2.png"        ] = { x = 33, y = 25 },
  ["units/human-magi/mage-attack-staff1.png"        ] = { x = 36, y = 25 },
  ["units/human-magi/mage-attack-staff2.png"        ] = { x = 36, y = 25 },
  ["units/human-magi/mage-defend.png"               ] = { x = 33, y = 25 },
  ["units/human-magi/red-mage.png"                  ] = { x = 33, y = 23 },
  ["units/human-magi/red-mage-attack-magic-1.png"   ] = { x = 33, y = 23 },
  ["units/human-magi/red-mage-attack-magic-2.png"   ] = { x = 33, y = 22 },
  ["units/human-magi/red-mage-attack-staff-1.png"   ] = { x = 36, y = 25 },
  ["units/human-magi/red-mage-attack-staff-2.png"   ] = { x = 36, y = 25 },
  ["units/human-magi/red-mage-defend.png"           ] = { x = 32, y = 23 },
  ["units/human-magi/arch-mage.png"                 ] = { x = 35, y = 24 },
  ["units/human-magi/arch-mage-attack-magic-1.png"  ] = { x = 35, y = 24 },
  ["units/human-magi/arch-mage-attack-magic-2.png"  ] = { x = 34, y = 24 },
  ["units/human-magi/arch-mage-attack-staff-1.png"  ] = { x = 35, y = 23 },
  ["units/human-magi/arch-mage-attack-staff-2.png"  ] = { x = 37, y = 23 },
  ["units/human-magi/arch-mage-defend.png"          ] = { x = 34, y = 24 },
  ["units/human-magi/great-mage.png"                ] = { x = 35, y = 22 },
  ["units/human-magi/great-mage-attack-magic-1.png" ] = { x = 35, y = 22 },
  ["units/human-magi/great-mage-attack-magic-2.png" ] = { x = 34, y = 22 },
  ["units/human-magi/great-mage-attack-staff-1.png" ] = { x = 37, y = 23 },
  ["units/human-magi/great-mage-attack-staff-2.png" ] = { x = 36, y = 23 },
  ["units/human-magi/great-mage-defend.png"         ] = { x = 34, y = 23 },
}

    
EoHS.palettes_and_ranges_effect = function(palettes_and_ranges)
  local result = {"effect",{apply_to="image_mod"}}
  for i,pr in ipairs(palettes_and_ranges) do
    table.insert(result[2], pr)
  end
  return result
end

EoHS.random_dress_up_options = function(unit)
  local result = {}
  local skin_index = EoHS.random("0..100")
  local hair_index = math.floor(skin_index * EoHS.random("0..100") / 100)
  local skin_table = {
    {  0,  80, 25,  0 },
    { 33, 100, 35,  0 },
    { 80, 180,100, 40 },
  }
  local hair_table = {
    {  0,  40, 30, 25 },
    { 20,  60, 50, 30 },
    { 76, 150, 80, 35 },
    { 86, 210, 50,  0 },
  }
  local table_val = function(table, index)
    for i,entry in ipairs(table) do
      if index < entry[1] then
        local prev = skin_table[i-1]
        local c = function(idx)
          local ref = prev[idx] + ((entry[idx] - prev[idx]) * index / (entry[1] - prev[1]))
          return ""..math.floor(EoHS.random("90..110") * ref / 100) end
        return = c(2)..","..c(3)..","..c(4)
        break
      end
    end
    return nil
  end
  result.recolor_skin = table_val(skin_table, skin_index)
  result.recolor_hair = table_val(hair_table, hair_index)
  result.hair = (unit.gender == "male") and "hooded" or "ponytail"
  return result
end

EoHS.dressed_up_unit_image_modded = function(palettes_and_ranges, unit, unit_image_base, options)
  local specify_palette = function(palette_specifier)
    if palette_specifier == "robes" then
          if unit.type ==     "Lich" then palette_specifier = "lich_robes"
      elseif unit.type ==     "Mage" then palette_specifier = "mage_robes"
      elseif unit.type == "Red Mage" then palette_specifier = "redmage_robes"
      else                                palette_specifier = "archplus_robes" end
    elseif palette_specifier == "hair" then
          if unit.type ==     "Lich" then palette_specifier = nil
      else                                palette_specifier = (unit.gender == "male") and "male_wizard_hair" or "female_wizard_hair" end
    elseif palette_specifier == "coat" then
          if unit.type ==     "Lich" then palette_specifier = nil
      elseif unit.type ==     "Mage" then palette_specifier = nil
      else                                palette_specifier = "redplus_coat" end
    elseif palette_specifier == "boots_and_frills" then
          if unit.type ==     "Lich" then palette_specifier = nil
      elseif unit.type ==     "Mage" then palette_specifier = "mage_shoes"
      else                                palette_specifier = "boots_and_frills" end
    elseif palette_specifier == "staff" then
          if unit.type ==     "Lich" then palette_specifier = "lich_staff"
      elseif unit.type ==     "Mage" then palette_specifier = "mage_staff"
      else                                palette_specifier = "staves_greatmageorb" end
    end
    return palette_specifier
  end
  
  local RCd_image_base = function(image_base, ...)
    local result = image_base
    for i,RC_pair in ipairs(arg) do
      EoHS.assert(type(RC_pair[1])=="string", "RC_pair with no palette?")
      local src_palette_specifier = specify_palette(RC_pair[1])
      local dst_range_info = RC_pair[2]
      if dst_range_info then
        if src_palette_specifier then
          src_palette_id = "EoHS_color_palette_"..src_palette_specifier
          if not palettes_and_ranges[src_palette_id] then
            table.insert(palettes_and_ranges, dress_up_palettes[src_palette_specifier])
            palettes_and_ranges[src_palette_id] = true
          end
          dst_range_id = "EoHS_color_range_"..dst_range_info
          if not palettes_and_ranges[dst_range_id] then
            table.insert(palettes_and_ranges,{ "color_range", { id=dst_range_id,
              rgb=dst_range_info..","..string.gsub(dst_range_info, "%d+", function(numstr) return ""..math.min(tonumber(numstr)+128,255) end)..",0,0,0" }})
            palettes_and_ranges[dst_range_id] = true
          end
          result = result.."~RC("..src_palette_id..">"..dst_range_id..")"
        end
      end
    end
    return result
  end
  
  local eye = eye_offsets[string.gsub(unit_image_base, "+female", "")]
    
  local image_aggregate = RCd_image_base(unit_image_base,
    { "human_skin", options.recolor_skin  },
    { "hair"      , options.recolor_hair  },
    { "robes"     , options.recolor_robes },
    { "coat"      , options.recolor_coat  },
    { "staff"     , options.recolor_staff },)
    
  local add_head = function(image_base, skin_palette, hair_palette, eye_x, eye_y, ...)
    local head_aggregate = RCd_image_base(image_base, { skin_palette, options.recolor_skin }, { hair_palette, options.recolor_hair })
    for i,crop_params in ipairs(arg) do crop_params.relative_to_base_image = image_base end
    head_aggregate = EoHS.image_aggregate_sampled   (head_aggregate, unpack(arg))
    head_aggregate = EoHS.image_aggregate_translated(head_aggregate, EoHS.offset_translated(eye, EoHS.offset_relative_to_base_image({x=eye_x, y=eye_y}, image_base)))
    image_aggregate = EoHS.image_aggregate_combine(image_aggregate, head_aggregate)
  end
    
  if ((unit.gender == "male") and (options.hair ~= "hooded")) or ((unit.gender == "female") and (options.hair ~= "ponytail")) then
    local mage_head_cut = function(eye_offs, sense)
      if sense then return { y2=eye_offs.y+2,x2=eye_offs.x+10 }
      return { y1=eye_offs.y+3,x2=eye_offs.x+10 }, { x1=eye_offs.x+11 }
    end
    image_aggregate = EoHS.image_aggregate_sampled(image_aggregate, mage_head_cut(eye))
    
    if (options.hair == "ponytail") or (options.hair == "hooded") then
      local other_image_base = string.gsub(unit_image_base,
        (unit.gender == "male") and "mage"        or "mage+female",
        (unit.gender == "male") and "mage+female" or "mage"       )
      local other_eye = eye_offsets[other_image_base]
      add_head(other_image_base, "human_skin", (unit.gender == "male") and "male_wizard_hair" or "female_wizard_hair",
        other_eye.x,other_eye.y, mage_head_cut(other_eye, true))
    elseif options.hair == "short" then
      add_head("units/human-peasants/ruffian.png", "ruffian_skin", "ruffian_hair", 35,28, { min={x=27,y=19}, max={x=41,y=29} }, {y=30,x1=31,x2=39})
    elseif options.hair == "wild" then
      add_head("units/elves-wood/druid.png", "elf_skin", "elf_hair", 37,29,
        { min={x=22,y=18}, max={x=44,y=31} },
        { min={x=22,y=32}, max={x=35,y=33} },
        { min={x=22,y=34}, max={x=34,y=35} },
        { min={x=22,y=36}, max={x=33,y=37} },
        { y=38,x1=22,x2=32 },
        { y=39,x1=22,x2=31 },
        { y=40,x1=22,x2=30 })
    elseif options.hair == "bald" then
      add_head("units/human-magi/elder-mage.png", "elder_mage_skin", "elder_mage_hair", 34,24, { min={x=28,y=17}, max={x=40,y=24} }, { min={x=29,y=25}, max={x=39,y=26} })
    elseif options.hair == "spiky" then
      add_head("units/human-outlaws/rogue.png", "human_skin", "rogue_hair", 34,26, { min={x=26,y=16}, max={x=41,y=28} })
    elseif options.hair == "loose" then
      add_head("units/human-outlaws/rogue+female.png", "human_skin", "rogue_hair", 34,26, { min={x=25,y=16}, max={x=42,y=27} }, {y=28,x1=27,x2=38}, {x=31,y1=29,y2=30})
    end
  end
  if (options.hair == "short") or (options.hair == "hooded") then
    eye.x = eye.x + 1
  end
  if options.spectre_helm then
    add_head("units/undead/spectre.png", nil, nil, 38,23, { min={x=26,y=7}, max={x=50,y=27} },
      { min={x=28,y=28}, max={x=50,y=30} }, { min={x=32,y=31}, max={x=48,y=35} })
    eye.y = eye.y + 2
  end
  if options.horned_helm then
    add_head("units/dwarves/lord-ranged.png", nil, nil, 34,36, { min={x=25,y=24}, max={x=41,y=32} },
      { y=33,x1=27,x2=40 }, { y=34,x1=28,x2=39 }, { y=35,x1=29,x2=35 }, { y1=35,y1=38,x1=29,x2=32 })
    eye.y = eye.y + 2
  end
  if options.wide_brimmed_hat then
    add_head("units/human-loyalists/duelist.png", nil, nil, 33,29, { min={x=20,y=14}, max={x=42,y=24} },
      { y=25,x1=26,x2=43 }, { y=26,x1=27,x2=42 }, { y=27,x1=30,x2=39 })
    eye.y = eye.y + 2
  end
  if options.chocobone_helm then
    add_head("units/undead-skeletal/chocobone.png", nil, nil, 35,17, { min={x=26,y=4}, max={x=43,y=14},
      { min={x=30,y=15}, max={x=40,y=16} }, { y=25,x1=26,x2=43 }, { y=26,x1=27,x2=42 }, { y=27,x1=30,x2=39 })
    eye.y = eye.y + 2
  end
  if options.crown then
    add_head("misc/leader-crown.png", nil, nil, 21,14, { min={x=17,y=5}, max={x=23,y=11} })
    add_head("misc/leader-crown.png", nil, nil, 21,15, { min={x=13,y=6}, max={x=16,y=11} }, { min={x=24,y=6}, max={x=27,y=11} })
    eye.y = eye.y + 2
  end
    
  return image_aggregate
end

>>)}
