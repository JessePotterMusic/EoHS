{EOHS_LUA_FILE (<<-- training.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery

--[[
summon_

energy_blast
mage_shield
wizard_sword

corridor_of_frost
summon_arctic_drake
dispelling_touch

fireball
group_teleport
summon_sea_serpent

aberrant_growth
circle_of_protection
haste

disenchant_area
dumbfound
disintegrate

summon_fire_dragon
meteor_storm
create_portal




summon_wolf
grow_vegetation
mount_dismount

mud_touch
summon_wose
regeneration

dehydration
downpour
summon_water_serpent

lightning_bolt
rampage
summon_gryphon

fissure
summon_yeti
blizzard

monsters_nest???
hurricane




curse_of_anxiety
summon_vampire_bat - absorb_bat
life_drain

poison_ground
summon_ghost
summon_skeleton

reanimating_touch
summon_chocobone
dark_pact

devour_soul
wraithform
zombie_attack

summon_skeletal_dragon
renounce_life / curse_life_once_more

zombie_mastery



volcano

summon_chimera

unused units, unintentional:
  Elvish Lady,Elder Mage,Royal Warrior,Troll Hero,Ancient Lich
  boats,
  Mermaid Initiate,
  Cuttle Fish,Giant Rat,Giant Scorpion,Tentacle of the Deep,
  Fire Guardian,
unused units, intentional:
  Giant Spider,
  drakes(burner+Armageddon,clasher,glider)]]


EoHS.skills = {
  realms = {
    {
      id = "evocation",
      names = {
        realm = _"Evocation",
        skill = _"Evocation skill",
        --practitioner = _"Evoker",
      },
      spells = {
        { "energy_blast", "wizard_sword", "mage_shield", },
        { "corridor_of_frost", "summon_arctic_drake", "dispelling_touch", },
      },
    },
    {
      id = "nature_magic",
      names = {
        realm = _"Nature magic",
        skill = _"Nature magic skill",
      },
      spells = {
        { "summon_wolf", "grow_vegetation", "mount_dismount", },
        { "mud_touch", "summon_wose", "regeneration", },
      },
    },
    {
      id = "necromancy",
      names = {
        realm = _"Necromancy",
        skill = _"Necromancy skill",
      },
      spells = {
        { "curse_of_anxiety", "summon_vampire_bat", "life_drain", },
        { "poison_ground", "summon_ghost", "summon_skeleton", },
      },
    },
  },
  talents = {
    { id="efficiency", name=_"Expert", description=_"Your spells cost 80% as much mana/gold" },
    { id="summoner", name=_"Summoner", description=_"Your summoning spells cost 60% as much AP, rounded up" },
    { id="enchanter", name=_"Enchanter", description=_"Your enchantment spells cost 60% as much AP, rounded up" },
    { id="farseer", name=_"Farseer", description=_"The range of your spells is doubled" },
    { id="archmage", name=_"Archmage", description=_"+40% fire/cold/arcane resistance, and you can train apprentices" },
  },
  alliances = {
    { id="military_commander", name=_"Human military", description=_"Loyalist faction plus Sergeant minus Mage\nLeadership\nProhibits L3 Necromancy spells" },
    { id="rascally_friends", name=_"Motley crew", description=_"Outlaws, including Ruffians\nSkirmisher" },
    { id="elvish_alliance", name=_"Elf-friend", description=_"Elves, Merman Hunters\nImproved forest movement and defense\nProhibits L3 Necromancy spells" },
    { id="dwarvish_alliance", name=_"Dwarvish alliance", description=_"Dwarves, and Gryphon Riders if you can summon them\n+20% physical resistances\nProhibits L3 Necromancy spells" },
    { id="orcish_mercenaries", name=_"Orcish mercenaries", description=_"Northerners\n+2 melee damage, +1 ranged damage" },
    { id="traveler", name=_"Traveler", description=_"Saurians, Peasants, Woodsmen\n+1 move, improved terrain movement and defenses" },
    { id="petty_necromancer", name=_"Petty necromancy", description=_"Undead faction minus Ghosts\nRequires an L3 Necromancy spell" },
  },
  perks = {},
}
for i,talent in ipairs(EoHS.skills.talents) do
  table.insert(EoHS.skills.perks, talent)
end
for i,alliance in ipairs(EoHS.skills.alliances) do
  table.insert(EoHS.skills.perks, alliance)
end

EoHS.unit_can_train = function(unit)
  return EoHS.get_unit_variable(unit, "is_wizard")
end

EoHS.init_skillset = function(skillset)
  for i,realm in ipairs(EoHS.skills.realms) do
    skillset[realm.id] = skillset[realm.id] or 0
  end
  for i,perk in ipairs(EoHS.skills.perks) do
    skillset[perk.id] = skillset[perk.id] or false
  end
end

EoHS.skillset_points_spent = function(skillset)
  local result = 0
  for i,realm in ipairs(EoHS.skills.realms) do
    result = result + skillset[realm.id]
  end
  local talents = 0
  for i,talent in ipairs(EoHS.skills.talents) do
    if skillset[talent.id] then
      talents = talents + 1
      result = result + talents
    end
  end
  local alliances = 0
  for i,alliance in ipairs(EoHS.skills.alliances) do
    if skillset[alliance.id] then
      result = result + alliances
      alliances = alliances + 1
    end
  end
  return result
end

EoHS.get_unit_skillset = function(unit)
  return EoHS.get_unit_variable(unit, "skillset")
end
EoHS.get_unit_skill = function(unit, name)
  return EoHS.get_unit_variable(unit, "skillset."..name)
end

EoHS.set_unit_skillset = function(unit, skillset)
  EoHS.set_unit_variable(unit, "skillset", skillset)
  EoHS.update_all_type_adjustments(unit)
end

EoHS.unit_total_skill_points = function(unit)
  return EoHS.get_wizard_setting(unit, "skill_points_at_level_0") + EoHS.get_wizard_setting(unit, "skill_points_per_level") * unit.level
end
EoHS.unit_skill_points_left = function(unit)
  return EoHS.unit_total_skill_points(unit) - EoHS.skillset_points_spent(EoHS.get_unit_skillset(unit))
end

EoHS.training_dialog_grid = function(dialog_context, skillset, old_skillset, total_points)
  local num_realm_entries = math.max(0, total_points - EoHS.skillset_points_spent(old_skillset)) + 1

  local g = function(contents) return { "grid", contents } end
  local r = function(contents) return { "row", contents } end
  local c = function(contents) return { "column", contents } end
  local l = function(text) return { "label", { label = text } } end
  local title = function(text) return { "label", { label = text, definition = "title" } } end
  local t = function(id) return { "text_box", { id = id } } end
  
  local update_total_points = function()
    wesnoth.set_dialog_value(total_points, "total_points_box")
    wesnoth.set_dialog_value(total_points - EoHS.skillset_points_spent(skillset), "points_remaining_box")
  end

  local total_points_grid = g{r{c{l(_"Total skill points:")}, c{t("total_points_box")}}}
  local points_remaining_grid = g{r{c{l(_"Skill points remaining:")}, c{t("points_remaining_box")}}}
  local summary_grid = g{r{c{total_points_grid}, c{points_remaining_grid}}}
  local realms_cols = {}
  for dummy,realm_ in ipairs(EoHS.skills.realms) do
    local realm = realm_
    local realm_rows = {
      r{c{l(realm.names.skill)}}
    }
    
    local set_level = function(level)
      for i=1,num_realm_entries+old_skillset[realm.id] do
        local level2 = i - 1
        local id = realm.id.."_level_"..level2
        wesnoth.set_dialog_value(level2 <= level, id)
      end
    end
    dialog_context.preshow(function() set_level(old_skillset[realm.id]) end)
    
    for i=1,num_realm_entries+old_skillset[realm.id] do
      local level = i - 1
      local id = realm.id.."_level_"..level
      table.insert(realm_rows, r{c{ {"toggle_button",{id=id,label=EoHS.substitute(_"Level $1|\n: ",{level})}} }})
      dialog_context.preshow(function()
        if level < old_skillset[realm.id] then wesnoth.set_dialog_active(false, id) end
        wesnoth.set_dialog_callback(function()
          skillset[realm.id] = level
          update_total_points()
          set_level(level)
        end, id)
        wesnoth.set_dialog_canvas(1, { {"image",{
          name="units/undead-necromancers/lich.png"
        }} }, id)
      end)
    end
    table.insert(realms_cols, c{g(realm_rows)})
  end
  local realms_grid = g{r(realms_cols)}
  
  
  --[[local num_talents = #EoHS.skills.talents
  local num_talents_cols = 3
  local talents_rows = {}
  for i,talent in ipairs(EoHS.skills.talents) do
    if (not talents_rows[1]) or (#talents_rows[#talents_rows][2] == num_talents_cols) then
      table.insert(talents_rows, r{})
    end
    table.insert(talents_rows[#talents_rows][2], c{ {"toggle_button",{id=talent.id.."_toggle",label=talent.name}} })
  end
  while #talents_rows[#talents_rows][2] <1 num_talents_cols do
    table.insert(talents_rows[#talents_rows][2], c{ {"spacer",{}} })
  end
  local talents_grid = g(talents_rows)]]
  
  local perk_toggle = function(perk)
    return {"toggle_button",{id=perk.id.."_toggle",label=perk.name}}
  end
  
  local talents_rows = {r{c{horizontal_alignment="left",title(_"Talents")}},r{c{border="all", border_size=3, l(_"Buying a talent costs one point,\nplus one for each talent you already have.")}}}
  for i,talent in ipairs(EoHS.skills.talents) do
    table.insert(talents_rows, r{c{horizontal_alignment="left",perk_toggle(talent)}})
  end
  
  local alliances_rows = {r{c{horizontal_alignment="left",title(_"Alliances")}},r{c{border="all", border_size=3, l(_"Your first alliance is free. Later alliances cost\none point for each alliance you already have.")}}}
  for i,alliance in ipairs(EoHS.skills.alliances) do
    table.insert(alliances_rows, r{c{horizontal_alignment="left",perk_toggle(alliance)}})
  end
  
  local perks_grid = g{
    r{c{
      border="all", border_size=8, g(talents_rows)
    }},
    r{c{
      border="all", border_size=8, g(alliances_rows)
    }}
  }
  
  local perk_update = function(perk)
    return function()
      skillset[perk.id] = wesnoth.get_dialog_value(perk.id.."_toggle")
      update_total_points()
    end
  end
  
  --[[dialog_context.set_total_skill_points = function(points)
    total_points = points
    update_total_points()
  end]]
  
  dialog_context.preshow(function()
    wesnoth.set_dialog_active(false, "total_points_box")
    wesnoth.set_dialog_active(false, "points_remaining_box")
    for i,perk in ipairs(EoHS.skills.perks) do
      wesnoth.set_dialog_callback(perk_update(perk), perk.id.."_toggle")
      wesnoth.set_dialog_value(skillset[perk.id], perk.id.."_toggle")
      wesnoth.set_dialog_active(not skillset[perk.id], perk.id.."_toggle")
    end
    update_total_points()
  end)

  return g{
    r{c{summary_grid}},
    r{c{g{r{c{realms_grid},c{perks_grid}}}}},
  }
end

>>)}
