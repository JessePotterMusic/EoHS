{EOHS_LUA_FILE (<<-- circle_of_protection.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery
local getmetatable,ipairs,next,pairs,setmetatable,tonumber,tostring,type,unpack = getmetatable,ipairs,next,pairs,setmetatable,tonumber,tostring,type,unpack
local wesnoth,table,string,math,os,debug,helper,_,EoHS,_G,_ENV = wesnoth,table,string,math,os,debug,EoHS.helper,EoHS._,EoHS,_G,nil

EoHS.make_spell("circle_of_protection", {
  image = "icons/stone_ring.png",
  name = _"Circle of Protection",
  description = _"You enchant a hex with a circle of protection. The circle blocks enemy wizards' magic as if it was a solid wall, and also blocks the harmful effects of your own and allies' spells. Also, if a unit in the circle is attacked, both sides will deal one-third their normal damage. There is no limit to how long a circle of protection lasts, but it disappears if an enemy unit enters it.",
  
  is_enchantment = true,
  
  base_cost = { action_points=7, mana=18 },
  base_range = 1,
  target_type = function(parameters)
    local actor = EoHS.get_unit(parameters.actor_id)
    local unit = EoHS.get_seen_unit(parameters.target_x,parameters.target_y,wesnoth.current.side)
    local unfogged = EoHS.hex_is_unfogged(parameters.target_x,parameters.target_y)
    return {
      short_name = _"ally or hex",
      name = _"Ally or empty hex",
      details = ((not unfogged) and _"You can't tell if that hex is occupied." or ""),
      validity = (unfogged and not (unit and wesnoth.is_enemy(unit.side, actor.side))) and "valid" or "impossible"
    }
  end,
  
  affected_hexes = function(parameters)
    return {{x=parameters.target_x,y=parameters.target_y,visual="help"}}
  end,
  
  happen = function(parameters)
    EoHS.begin_casting(parameters.actor_id, parameters.target_x, parameters.target_y)
    wesnoth.fire("sound", { name = "magic-holy-miss-2.ogg" })
    EoHS.finish_casting(parameters.actor_id)
  end,
})

>>)}
