{EOHS_LUA_FILE (<<-- mud_touch.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery
local getmetatable,ipairs,next,pairs,setmetatable,tonumber,tostring,type,unpack = getmetatable,ipairs,next,pairs,setmetatable,tonumber,tostring,type,unpack
local wesnoth,table,string,math,os,debug,helper,_,EoHS,_G,_ENV = wesnoth,table,string,math,os,debug,EoHS.helper,EoHS._,EoHS,_G,nil

EoHS.make_touch_enchantment = function(id, action)
  action.is_enchantment = true
  if not action.affected_hexes then action.affected_hexes = function(parameters)
    local actor = EoHS.get_unit(parameters.actor_id)
    return {{x=actor.x,y=actor.y,visual="help"}}
  end end
  if not action.make_extra_attributes then action.make_extra_attributes = function(parameters, make_aspect)
    local actor = EoHS.get_unit(parameters.actor_id)
    local touch_enchantment = EoHS.get_unit_variable(actor, "touch_enchantment")
    local details = ""
    local validity = "valid"
    if touch_enchantment == id then
      validity = "impossible"
      details = _"You already have that spell active."
    elseif touch_enchantment then
      validity = "undesirable"
      details = _"Replaces your current touch spell"
    end
      
    make_aspect.type_and_details(_"Touch enchantment", details, validity)
  end end
  if not action.happen then action.happen = function(parameters)
    EoHS.begin_casting(parameters.actor_id)
    local actor = EoHS.get_unit(parameters.actor_id)
    EoHS.set_unit_variable(actor, "touch_enchantment", "mud_touch")
    EoHS.update_all_type_adjustments(actor)
    if action.sound then wesnoth.fire("sound", { name = action.sound }) end
    EoHS.put_unit(actor, {immediate=true})
    EoHS.finish_casting(parameters.actor_id)
  end end
  
  EoHS.make_spell(id, action)
end

EoHS.make_touch_enchantment("mud_touch", {
  image = "attacks/mud-glob.png",
  name = _"Mud Touch",
  description = _"You enchant your default melee attack. The next time you hit on offense, the fight ends and the enemy is transformed into a ghastly mudcrawler. It retains its level, hitpoints, and approximate attack strength, but its base movement is divided by 2 (rounded down), and all its other stats are replaced with the new type. Works on any unit except for wizards and mudcrawlers.",
  
  base_cost = { action_points=6, mana=5 },
  
  sound = "squishy-hit.wav",
})

EoHS.mud_touch_special = { "dummy", {
  id = "EoHS_mud_touch",
  name = _"mud touch",
  description = _"The next time this attack hits on offense, the fight ends and the defender turns into a mudcrawler of similar strength. Works on any unit except for wizards and mudcrawlers."
}}

>>)}
