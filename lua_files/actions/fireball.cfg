{EOHS_LUA_FILE (<<-- fireball.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery
local getmetatable,ipairs,next,pairs,setmetatable,tonumber,tostring,type,unpack = getmetatable,ipairs,next,pairs,setmetatable,tonumber,tostring,type,unpack
local wesnoth,table,string,math,os,debug,helper,_,EoHS,_G,_ENV = wesnoth,table,string,math,os,debug,EoHS.helper,EoHS._,EoHS,_G,nil

local affected_hexes_func = function(parameters)
  local result = {{x=parameters.target_x, y=parameters.target_y, visual="harm"}}
  for x,y in helper.adjacent_tiles(parameters.target_x, parameters.target_y) do
    table.insert(result, {x=x, y=y, visual="harm"})
  end
  return result
end
local get_fireball_attack = function(actor)
  for attack in helper.child_range(actor, "attack") do
    if attack.name == "EoHS_evocation_skill_ranged_attack" then
      local result = EoHS.deep_copy(attack)
      EoHS.remove_subtags(result, "specials.chance_to_hit", "magical")
      return result
    end
  end
end

EoHS.make_spell("fireball", {
  image = "attacks/fireball.png",
  name = _"Fireball",
  description = _"Every unit in a diameter-3 circle is subject to your ranged fireball attack, except with no retaliation and without the Magical special.",
  
  base_cost = { action_points=8, mana=16 },
  base_range = 3,
  target_type = EoHS.target_types.hex,
  
  affected_hexes = affected_hexes_func,
  
  make_extra_attributes = function(parameters, make_aspect)
    local affected_hexes = affected_hexes_func(parameters)
    local actor = EoHS.get_unit(parameters.actor_id)
    for i,hex in ipairs(affected_hexes) do
      local unit = EoHS.get_seen_unit(hex.x,hex.y,actor.side)
      if unit then
        local value,details
        local name = (unit.name == "") and unit.language_name or unit.name
        if EoHS.unit_is_immune_to_direct_spell_damage(unit) then
          value = _"None"
          details = EoHS.unit_is_immune_to_direct_spell_damage_description(unit)
        else
          local attack_context = EoHS.game_action_simulations.fleshed_out_attack_context({attacker={unit=actor,attack=get_fireball_attack(actor)},defender={unit=unit}})
          value = attack_context.attacker.damage.."-"..attack_context.attacker.attacks
          details = ""
        end
        make_aspect.type_value_and_details(EoHS.substitute(_"Damage to $1|", {name}), value, details)
      end
    end
  end,
  
  happen = function(parameters)
    local affected_hexes = affected_hexes_func(parameters)
    local actor = EoHS.get_unit(parameters.actor_id)
    for i,hex in ipairs(affected_hexes) do
    end
  end,
})

>>)}
