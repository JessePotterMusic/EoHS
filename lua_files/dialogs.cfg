{EOHS_LUA_FILE (<<-- dialogs.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery

local fake_listbox_background = {"rectangle",{
  x = 0,
  y = 0,
  w = "(width)",
  h = "(height)",
  fill_color = EoHS.macros.GUI__BACKGROUND_COLOR_ENABLED,
}}
EoHS.fake_listbox_canvas_unselected = {fake_listbox_background}
EoHS.fake_listbox_canvas_selected = EoHS.deep_copy(EoHS.macros.GUI__LISTBOX_SELECTED_CELL)
table.insert(EoHS.fake_listbox_canvas_selected, 1, fake_listbox_background)

EoHS.fake_listbox_entry = function(dialog_context, size_str, canvas_extras, selected, switch_func)
  local canvas
  local contents = {id = dialog_context.make_unique_id(), label=size_str}
  local result
  if selected then
    result = {"label",contents}
    canvas = EoHS.deep_copy(EoHS.fake_listbox_canvas_selected)
  else
    result = dialog_context.button(contents, switch_func)
    canvas = EoHS.deep_copy(EoHS.fake_listbox_canvas_unselected)
  end
  for i,canvas_extra in ipairs(canvas_extras) do
    table.insert(canvas, canvas_extra)
  end
  
  dialog_context.preshow(function()
    wesnoth.set_dialog_canvas(1, canvas, contents.id)
    if not selected then
      wesnoth.set_dialog_canvas(3, canvas, contents.id)
      wesnoth.set_dialog_canvas(4, canvas, contents.id)
    end
  end)
  
  return result
end

EoHS.unit_info_canvas = function(unit, extra_strings)
  local canvas = { {"image",{
    x = 3,
    y = 3,
    w = "(height-6)",
    h = "(height-6)",
    name = unit.image,--TODO EoHS.unit_image_72x72(unit)
  }} }
  local strings = {}
  if unit.name ~= "" then
    table.insert(strings, unit.name)
  else
    table.insert(strings, unit.language_name)
  end
  table.insert(strings, "("..unit.x..","..unit.y..")")
  for i,extra_string in ipairs(extra_strings) do
    table.insert(strings, extra_string)
  end
  for i,string in ipairs(strings) do
    local buffer=5
    local fontgapwanted=2
    local numstr=#strings
    local fontsize=14
    local totalloss = buffer*2 + numstr*fontsize
    local heightwanted = totalloss+(numstr-1)*fontgapwanted
    local fontgapstr="(if(height<"..heightwanted..",(height-"..totalloss..")/"..(numstr-1)..","..fontgapwanted.."))"
    table.insert(canvas, {"text",{
      x = "(height-1)",
      y = "(("..(i-1).."*("..fontsize.."+"..fontgapstr.."))+"..buffer..")",
      w = "(text_width)",
      h = "(text_height)",
      font_size = fontsize,
      color = "221, 221, 221, 255",
      text = "('"..string.."')", -- TODO can we handle both singlequotes and parentheses in the source string?
    }})
  end
  return canvas
end

EoHS.string_with_validity = function(validity, string)
  local color
  if validity == "valid" then
    color = "#99FF99"
  elseif validity == "undesirable" then
    color = "#CCCC00"
  elseif validity == "impossible" then
    color = "#CC0000"
  else
    EoHS.err("invalid validity")
  end
  return "<span color='"..color.."'>"..string.."</span>"
end

EoHS.make_dialog_context = function(enter_callback, cancel_callback)
  local top_level = {
    {"tooltip",{id="tooltip_large"}},
    {"helptip",{id="helptip_large"}},
  }

  local preshow_list = {}
  local preshow = function(func) table.insert(preshow_list, func) end
  local preshow_func = function() for i,func in ipairs(preshow_list) do func() end end
  
  local postshow_list = {}
  local postshow = function(func) table.insert(postshow_list, func) end
  local postshow_func = function() for i,func in ipairs(postshow_list) do func() end end
  
  local button_list = {}
  button_list[-1] = enter_callback
  button_list[-2] = cancel_callback
  local make_button_return_value = function(func)
    table.insert(button_list, func)
    return #button_list
  end
  
  local next_id_number = 0
  local make_unique_id = function()
    next_id_number = next_id_number + 1
    return "dialog_context_fiat_id_"..next_id_number
  end
  return {
    preshow = preshow,
    postshow = postshow,
    make_button_return_value = make_button_return_value,
    make_unique_id = make_unique_id,
    add_top_level = function(wml_tag) table.insert(top_level, wml_tag) end,
    button = function(wml_table, func)
      local result = EoHS.deep_copy(wml_table)
      result.return_value = make_button_return_value(func)
      return {"button",result}
    end,
    label_with_validity = function(validity, wml_table)
      local result = EoHS.deep_copy(wml_table)
      if not result.id then
        result.id = make_unique_id()
      end
      
      preshow(function()
        wesnoth.set_dialog_canvas(1, { {"text",{
                  x = "0",
                  y = "0",
                  w = "(text_width)",
                  h = "(text_height)",
                  font_size = 14,
                  --colour = colour,
                  text = EoHS.string_with_validity(validity, result.label),
                  text_markup = true,
        }} }, result.id)
      end)
      return {"label",result}
    end,
    show = function(grid)
      --EoHS.err(wesnoth.debug(grid))
      table.insert(top_level, grid)
      button_list[wesnoth.show_dialog(top_level, preshow_func, postshow_func)]()
    end,
  }
end

--[[
EoHS.dialog_grid = function(rows, columns, ...)
  local result = { "grid", {} }
  for r = 1, rows do
    local row = { "row", {} }
    for c = 1, columns do
      local column = { "column", {} }
      local idx = (r-1)*columns + c
      if idx > arg[n] then
      table.insert(column[2], arg[idx])
      table.insert(row[2], column)
    end
    table.insert(result[2], row)
  end
  return result
end
]]

>>)}
