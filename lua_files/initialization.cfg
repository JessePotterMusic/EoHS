{EOHS_LUA_FILE (<<-- initialization.cfg
-- #textdomain wesnoth-Era_of_High_Sorcery

EoHS.init_campaign = function(player_picks_settings)
  EoHS.begin_event() -- Most of the time we put these outside the function, directly in the [lua] code=,
  -- but here we want the campaign-initing command - the only thing called directly from WML -
  -- to be as short as possible.
  
  EoHS.set_variable("player_picks_settings", player_picks_settings)
  EoHS.set_variable("settings_inited", false)
  EoHS.set_variable("show_menu_item", false)
  wesnoth.fire("set_menu_item", {
    id = "EoHS_menu_item",
    image = "attacks/staff-magic.png~SCALE(36,36)",
    description = _"EoHS actions",
    { "show_if", {
      { "variable", {
        name="EoHS.show_menu_item",
        boolean_equals="true",
      }}
    }},
    { "command", {
      { "lua", {
        code = [[--EoHS.menu_item_invoked
EoHS.begin_event()
EoHS.menu_item_invoked()
EoHS.end_event()]]
      }},
    }},
  })
  local leaders = EoHS.get_units({ canrecruit=true, type="Red Mage" })
  for i,leader in ipairs(leaders) do
    EoHS.set_unit_variable(leader, "is_starting_wizard", true)
    EoHS.put_unit(leader)
  end
  EoHS.init_scenario()
  
  EoHS.end_event()
end

EoHS.init_scenario = function()
  for i,event in pairs(EoHS.events) do
    wesnoth.fire("event", event)
  end
  EoHS.set_variable("scenario_inited", true)
end

EoHS.init_settings = function()
  EoHS.set_variable("settings_inited", true)
  if EoHS.get_variable("player_picks_settings") then
    EoHS.current_player_picks_settings()
  else
    EoHS.set_variable("settings", EoHS.map_specific_default_settings())
  end
  
  EoHS.set_variable("show_menu_item", true)
  local leaders = EoHS.get_units({ EoHS.has_unit_variable("is_starting_wizard") })
  for i,unit in ipairs(leaders) do
    local variables = EoHS.force_unit_variables_tag(unit)
    local skillset = EoHS.force_subtag(variables, "skillset")
    local settings = EoHS.force_subtag(variables, "settings")
    variables.is_wizard = true
    EoHS.init_skillset(skillset)
    EoHS.init_wizard_settings(settings)
    local level = EoHS.get_wizard_setting(unit, "starting_level")
    if level <= 1 then
      unit.type = "Mage"
      EoHS.set_unit_variable(unit, "level_adjustment", level-1)
    elseif level == 2 then
      unit.type = "Red Mage"
    elseif level == 3 then
      unit.type = "Arch Mage"
    elseif level >= 4 then
      unit.type = "Great Mage"
      EoHS.set_unit_variable(unit, "level_adjustment", level-4)
    else EoHS.err("bad starting level") end
    EoHS.update_all_type_adjustments(unit)
    unit.hitpoints = nil
    EoHS.set_unit_variable(unit, "mana", EoHS.unit_mana_cap(unit) or 0)
    EoHS.put_unit(unit)
  end
end

EoHS.events = {}

EoHS.synchronized = false
local nested_events = 0
EoHS.begin_event = function()
  nested_events = nested_events + 1
  if nested_events == 1 then
    EoHS.synchronized = true
    EoHS.puttable_unit_tables = {}
  end
end
EoHS.end_event = function()
  nested_events = nested_events - 1
  if nested_events == 0 then
    EoHS.synchronized = false
    EoHS.puttable_unit_tables = nil
  end
end

EoHS.create_oneshot_event = function(name, code)
  wesnoth.fire("event", {
    name = name,
    { "lua", {
      code = [[--EoHS.create_oneshot_event("]]..name..[[", ...)
EoHS.begin_event()
]]..code..[[
EoHS.end_event()]]
    }},
  })
end

EoHS.set_simple_event = function(name, func)
  table.insert(EoHS.event_functions, func)
  table.insert(EoHS.events, {
    name = name,
    first_time_only = "no",
    { "lua", {
      code = [[--EoHS.set_simple_event("]]..name..[[", ...)
EoHS.begin_event()
EoHS.event_functions[]]..#EoHS.event_functions..[[]()
EoHS.end_event()]]
    }},
  })
end

EoHS.set_simple_event("preload", function()
  wesnoth.fire("insert_tag", {
    name = "command",
    variable = "EoHS.preload"
  })
end)

EoHS.next_scenario_initing_event_names = {
  "prestart", "start", "side_turn", "turn_refresh", "side_turn_end", "prerecruit", "recruit", "moveto"
  -- deliberately omitted: attack (because the combat events rely on the fact that they all exist before the combat),
  -- preload (because it could create different behavior after a load)
}
EoHS.next_scenario_initing_event = function(name)
  return { "event", {
    name = name,
    id = "EoHS_next_scenario_initing_event_"..name,
    first_time_only = "no",
    { "filter_condition", {
      { "variable", {
        name = "EoHS.scenario_inited",
        boolean_equals = false
      }},
    }},
    { "insert_tag", {
      name = "command",
      variable = "EoHS.preload"
    }},
    { "lua", {
      code = [[--EoHS.next_scenario_initing_event("]]..name..[[")
EoHS.begin_event()
EoHS.init_scenario()
EoHS.end_event()]]
    }},
  }}
end

-- These events can normally be undone, so we don't want to trigger events on them unless we have to.
-- But we do want units to be standardized ASAP if the scenario does something!
EoHS.selective_unit_standardization_event_names = {
  "moveto"
}
EoHS.selective_unit_standardization_event = function(name)
  return {
    name = name,
    first_time_only = "no",
    { "filter_condition", {
      { "have_unit", {
        EoHS.is_on_the_map,
        lua_function = "EoHS.standardize_wunit"
      }},
    }},
    { "lua", {
      code = [[--EoHS.selective_unit_standardization_event
EoHS.begin_event()
EoHS.standardize_units()
EoHS.end_event()]]
    }},
  }
end
for i,name in ipairs(EoHS.selective_unit_standardization_event_names) do
  table.insert(EoHS.events, EoHS.selective_unit_standardization_event(name))
end

EoHS.standardize_units = function()
  local units = EoHS.get_units({ EoHS.is_on_the_map })
  for i,unit in ipairs(units) do
    if EoHS.standardize_unit(unit) then EoHS.put_unit(unit) end
  end
end

EoHS.standardize_wunit = function(wunit) EoHS.standardize_unit(wunit.__cfg) end
EoHS.standardize_unit = function(unit)
  local subtag_ids = {}
  local did_anything = false
  for i,subtag in ipairs(unit) do
    if subtag.id then subtag_ids[subtag.id] = true end
    if subtag[1] == "attack" then
      local special_ids = {}
      local specials = EoHS.force_subtag(subtag, "specials")
      for i,special in ipairs(specials) do
        if special.id then special_ids[special.id] = true end
      end
      for i,special in ipairs(EoHS.universal_attack_specials) do
        if not special_ids[special.id] then
          table.insert(specials, special)
          did_anything = true
        end
      end
    end
  end
  for i,name in ipairs(EoHS.next_scenario_initing_event_names) do
    if not subtag_ids["EoHS_next_scenario_initing_event_"..name] then
      table.insert(unit, EoHS.next_scenario_initing_event(name))
      did_anything = true
    end
  end
  return did_anything
end


local scenario_over_event = function()
  EoHS.standardize_units()
  EoHS.set_variable("show_menu_item", false)
  EoHS.set_variable("scenario_inited", false)
end
EoHS.set_simple_event("victory", scenario_over_event)
EoHS.set_simple_event("defeat", scenario_over_event)
EoHS.set_simple_event("side_turn", function()
  if not EoHS.get_variable("settings_inited") then EoHS.init_settings() end
  local units = EoHS.get_units({ EoHS.is_on_the_map })
  for i,unit in ipairs(units) do
    local put = false
    if EoHS.standardize_unit(unit) then put = true end
    if EoHS.earn_mana_income(unit) then put = true end
    if EoHS.unit_has_actions(unit) and (EoHS.get_unit_variable(unit, "extra_action_points") ~= 5) then
      EoHS.set_unit_variable(unit, "extra_action_points", 5)
      put = true
    end
    if put then EoHS.put_unit(unit) end
  end
  --EoHS.menu_item_invoked()
end)
EoHS.set_simple_event("turn_refresh", function()
  EoHS.standardize_units()
end)
EoHS.set_simple_event("side_turn_end", function()
  EoHS.standardize_units()
end)

>>)}
